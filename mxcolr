#!/usr/bin/env bash

# set -o pipefail
# set -o errtrace
# source $MXS/m.lib/lib.mxtrap.sh

# if tty -s; then mlg interactive; else mlg none-intreractive;fi

 MXC_V='mxc-v1.3'                    ; export MXC_V
MXBASE=$(dirname "$(realpath "$0")") ; export MXBASE
MXDIST=~/.config/mxc          ; export MXDIST
MXTEMP=/tmp/mxc                      ; export MXTEMP

MXSNAP=$MXBASE/snapshots    ; export MXSNAP
MTHEME=$MXTEMP/theme.mx     ; export MTHEME
OTHEME=$MXDIST/theme.mx     ; export OTHEME

M_SEED=$MXTEMP/mx-seed      ; export M_SEED
O_SEED=$MXDIST/mx-seed      ; export O_SEED

if ! command -v pastel &> /dev/null; then
  echo "pastel not found."; echo " ==> https://github.com/sharkdp/pastel#installation"; exit 1;
fi

if [ -d "$MXLIB" ]; then . "$MXLIB"/lib.common.sh; else mlg () { echo "${FUNCNAME[1]}:${BASH_LINENO[1]} => ${*}" >> /tmp/mxsh.log; }; fi

mkdir "$MXDIST" -p 2>/dev/null || true 
mkdir "$MXSNAP" -p 2>/dev/null || true 
mkdir /tmp/{mxc,mxc_hist} 2>/dev/null || true 

##########

####################################################
# VARIABLES ########################################
MX_CC=(C{00..15}); MX_CX=(CX{1..6}); MX_CK=(DK{0..9}); MX_CL=(DL{0..9}) 
MX_CM=({S{B,F},W{B,F},E{B,F},X{B,F},O{B,F}}G W{B,F}X)
#....................................................
MX_VARS=( "${MX_CC[@]}" "${MX_CX[@]}" "${MX_CK[@]}" "${MX_CL[@]}" "${MX_CM[@]}" )
MX_TERM=( "${MX_VARS[@]/#/T}" )
# mapfile -t MX_VARS <<<"$(eval echo \$\{MX_C{C,X,K,L,M}\[\@\]\}))"
#####################################################
##############################################
for src in "$MXBASE"/src/*.sh; do . "$src"; done
#  ............................ .........................................#
! [ -e "$OTHEME" ] && InfoDone 1 ' No Live Schema. run: mxcolr --generate' &&  InfoDone 'continueing  with sample files' 
#  ............................ .........................................#
ClearTemp     () { Info ' Cleaning temp'   ; rm "$MXTEMP"/*             ; } 
LoadTempTheme () { ( . "$MTHEME" && InfoDone ' Load Temp Theme' ) || ( . "$OTHEME" && InfoDone ' Load Live Theme' ) ; }
LoadTempSeed  () { ( . "$M_SEED" && InfoDone ' Load Temp Seed'  ) || ( . "$O_SEED" && InfoDone ' Load Live Seed'  ) ; }
#  ............................ .........................................#
CopyTempSeed  () { Info ' Copy Live Seed' ; cp -v "$O_SEED" "$M_SEED"                      ; }
BackupDist    () { Info ' Backup Live'    ; cp -v "$MXDIST" /tmp/mxc_hist/"$(date +%s)" -r ; }
#  ............................ .........................................#
LoadProdTheme () { . "$OTHEME" || . "$MXBASE/assets/samples/theme.mx"; }
LoadProdSeed  () { . "$O_SEED" || . "$MXBASE/assets/samples/mx-seed" ; }

#  ............................ .........................................#
LoadProdTheme
#  ............................ .........................................#
# ##############################
GetPlugName () {
  local BS="${BASH_SOURCE[1]}"; BS=${BS##*/}
  BS="${BS::-3}"; BS="${BS:2}"
  echo "$BS" 
}
SourcePlugs () { for plug in "$MXBASE"/plugins/*.sh; do . "$plug"; done; }
################################
# ##############################
# ////////////////////////////  
Demo () {
  Demo_block
  Demo_dot
  MXDotLine
  fillCols
}
DemoAll () {
  Demo_card
  Demo_slant
  Demo_shades3
  Demo_shades4

  Demo_dot_slant
  MXDotLine
  fillCols
}

LoadPreview () { CopyTempSeed ; LoadTempTheme ; apply_tmux ; }
RestoreTmux   () {
  [ -e "$MXDIST/tmuxpre" ] && cp "$MXDIST/tmuxpre" "$MXDIST/tmux.mx"
  [ "$TMUX" ] && apply_tmux
}
Revert () {
  ClearTemp
  CopyTempSeed
  UpdatePalette
  RestoreTmux
  Demo
}

ApplyTemplates () {
  ! command -v envsubst &> /dev/null && Info 1 "envsubst command not found" && return 1
  for tpl_path in "$MXBASE"/templates/*; do
    local tpl="${tpl_path##*/}"

    [[ ! "$XOPT" == *"full"* ]] && PromptContinue "$tpl"
    [[ ! "$REPLY" =~ ^[Yy]$ ]] || [[ "$XOPT" == *"no$tpl"* ]] && InfoIgnore "$tpl" && continue 
    # if [ -e /tmp/mxc/"$tpl" ]; then
    envsubst < "$tpl_path" | tee \
      >(cat > /tmp/mxc/"$tpl") \
      >(cat > "$MXDIST/$tpl") &> /dev/null; # XXX read from env/config
  done
}
ApplyPlugs () {
  BackupDist

  for plug_path in "$MXBASE"/plugins/*.sh; do
    local plugname; plugname="$(basename "$plug_path" | cut -d'-' -f2 | cut -d'.' -f1)"

    [[ ! "$XOPT" == *"full"* ]] && PromptContinue "$plugname"
    [[ ! "$REPLY" =~ ^[Yy]$ ]] || [[ "$XOPT" == *"no$plugname"* ]] && InfoIgnore "$plugname" && continue 

    local applyfn="apply_${plugname}"; ! [[ "$XOPT" == *"full"* ]] && "$applyfn"
  done
}

ReGenerate () {
  UpdatePalette 
  SourcePlugs
  ReleaseSeed
  ReleaseTheme
  Demo; ls "$MXTEMP" && PressToContinue "drafts ready" "$MXTEMP"
  # ............................ #
  ApplyTemplates
  ApplyPlugs
} 
# ............................ #
Generate () {
  GeneratePalette

  [[ -n "$TMUX" ]] && . "$MXBASE"/plugins/2-tmux.sh

  Demo

  PrompRand
  case $REPLY in
    k ) Info 'Keeping draft ·'; SourcePlugs    ;;
    u ) Info 'Proceeding ····'; ReGenerate ;;
    n ) Info 'Again ·········'; Generate  ;;
    d ) Info 'Full Demo ·····'; DemoAll    ;;
    * ) Info 'Reverting ·····'; Revert     ;;
  esac
  mlg "━✔━━━┛"
} # ............................ #
{
  mlg "━━━━<XOPT>━━┓"
  menu="$1" ; shift ; XOPT="$*"
  [[ "$XOPT" == *"verbose"* ]] && VERBOSE=1
  mlg "━✔━━<XOPT>━━ ${XOPT}"
}
# ............................ #
{
  mlg "━━━━<MENU>━━┓"
  case $menu in
    -g | --generate     ) Generate      ;;
    -u | --update       ) ReGenerate    ;;
    -U | --update-force ) XOPT+='full'  ; ReGenerate ;;
    -d | --demo         ) Demo          ;;
    -D | --demo-all     ) DemoAll       ;;
    -i | --init         ) LoadPreview   ; Demo_block ;;
    -l | --list         ) ListSnapshots ;;
    -s | --save         ) SaveSnapshot  ;;
    -x1                 ) XP_1          ;;
    -x2                 ) XP_2          ;;
    *                   ) MXIntro       ;;
  esac
  mlg "━✔━━<MENU>━━┛"
}
# ............................ #

# MXDotLine
exit 0

# //////////////////////////// #
################################
